
```{r fig2-precalc}
datafile <- file.path (here, "data-raw", "pkgstats-results.Rds")
f_fig2_aut_ctb <- file.path (v_data_dir, "fig2-aut-ctb.Rds")
calc_fig2_aut_ctb <- !file.exists (f_fig2_aut_ctb)
f_fig2_lic <- file.path (v_data_dir, "fig2-lic.Rds")
calc_fig2_lic <- !file.exists (f_fig2_lic)
```

```{r fig2-aut-ctb, eval = calc_fig2_aut_ctb}
x <- load_pkgstats_data (datafile, raw = TRUE, latest = FALSE)
do1 <- function (x, year = 2018) {
    xy <- x |>
        filter (year <= !!year) |>
        group_by (package) |>
        slice_max (date)
    c (year = year,
       n_aut = mean (xy$desc_n_aut),
       n_ctb = mean (xy$desc_n_ctb))
}
years <- sort (unique (x$year))
n <- vapply (years, function (y) do1 (x, y), numeric (3))
n <- data.frame (t (n))
saveRDS (n, f_fig2_aut_ctb)
```

```{r fig2-lic, eval = calc_fig2_lic}
x <- load_pkgstats_data (datafile, raw = TRUE, latest = FALSE)
do1 <- function (x, year = 2018) {
    xy <- x |>
        filter (year <= !!year) |>
        group_by (package) |>
        slice_max (date)
    lic <- unlist (strsplit (xy$license, "\\|"))
    lic <- unique (gsub ("^\\s*|\\s*$", "", lic))
    c (year = year, n = length (lic))
}
years <- sort (unique (x$year))
nlic <- vapply (years, function (y) do1 (x, y), numeric (2))
nlic <- data.frame (t (nlic))
saveRDS (nlic, f_fig2_lic)
```




```{r fig2-num_aut_ctb, echo = FALSE, warning = FALSE, fig.width = 7, fig.height = 3.5, fig.cap = "**Figure 2.**"}

p1 <- readRDS (f_fig2_aut_ctb) |>
    rename (aut = n_aut, ctb = n_ctb) |>
    pivot_longer (cols = c (aut, ctb)) |>
    ggplot (aes (x = year, y = value, colour = name)) +
    geom_smooth (method = "loess", formula = y ~ x, se = FALSE) +
    ggtitle ("A: Numbers of authors and contributors") +
    theme (legend.position = c (0.2, 0.4),
           legend.background = element_rect(fill='transparent', colour='transparent'))

p2 <- readRDS (f_fig2_lic) |>
    ggplot (aes (x = year, y = n)) +
    geom_line () +
    ylab ("Number of distinct licenses") +
    ggtitle ("B: Numbers of licenses")

p1 | p2
```
