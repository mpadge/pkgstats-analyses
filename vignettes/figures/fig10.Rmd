
```{r fig10-precalc}
datafile <- file.path (here, "data-raw", "pkgstats-results.Rds")
f_fig10 <- file.path (v_data_dir, "fig10.Rds")
calc_fig10 <- !file.exists (f_fig10)
```

```{r fig10-calc, eval = calc_fig10}
x <- load_pkgstats_data (datafile, raw = TRUE, latest = FALSE)
do1 <- function (x, year = 2018, cran_by_year = TRUE) {

    if (cran_by_year) {
        xy <- x |>
            filter (year <= !!year) |>
            group_by (package) |>
            slice_max (date)
    } else {
        xy <- x |>
            filter (year == !!year)
    }

    tot_R <- xy$blank_lines_R + xy$comment_lines_R + xy$loc_R
    tot_src <- xy$blank_lines_src + xy$comment_lines_src + xy$loc_src

    tabs <- length (which (xy$indentation < 0)) /
        length (which (!is.na (xy$indentation)))
    indentation <- mean (xy$indentation [xy$indentation >= 0], na.rm = TRUE)

    c (year = year,
       blank_R = mean (xy$blank_lines_R / tot_R, na.rm = TRUE),
       blank_src = mean (xy$blank_lines_src / tot_src, na.rm = TRUE),
       comment_R = mean (xy$comment_lines_R / tot_R, na.rm = TRUE),
       comment_src = mean (xy$comment_lines_src / tot_src, na.rm = TRUE),
       rel_space_R = mean (xy$rel_space_R, na.rm = TRUE),
       tabs = tabs,
       indentation = indentation)
}
years <- sort (unique (x$year))

n1 <- vapply (years, function (y) do1 (x, y, cran_by_year = TRUE), numeric (8))
n1 <- data.frame (t (n1))
n1$what <- "cran_by_year"

n2 <- vapply (years, function (y) do1 (x, y, cran_by_year = FALSE), numeric (8))
n2 <- data.frame (t (n2))
n2$what <- "annual"
saveRDS (rbind (n1, n2), f_fig10)
```


```{r fig10, echo = FALSE, warning = FALSE, fig.width = 7, fig.height = 3.5, fig.cap = "**Figure 10.**"}

x1_cran <- readRDS (f_fig10) |>
    filter (what == "cran_by_year") |>
    select (year, blank_R, blank_src, comment_R, comment_src) |>
    pivot_longer (cols = c (blank_R, blank_src, comment_R, comment_src))
p1 <- readRDS (f_fig10) |>
    filter (what == "annual") |>
    select (year, blank_R, blank_src, comment_R, comment_src) |>
    pivot_longer (cols = c (blank_R, blank_src, comment_R, comment_src)) |>
    ggplot (aes (x = year, y = value, colour = name)) +
        geom_line () +
        geom_line (data = x1_cran, lty = 2, show.legend = FALSE) +
        ggtitle ("A: Blank & comment lines") +
        ylab ("Proportion") +
        theme (legend.title = element_blank(),
               legend.position = c (0.2, 0.8),
               legend.background = element_rect(fill='transparent', colour='transparent'))

x2 <- readRDS (f_fig10)
coeff_fig10_p2 <- max (x2$indentation) / max (x2$tabs)
colours_fig10_p2 <- c ("rel_space" = "red",
                       "tabs" = "blue",
                       "indentation" = "green")
x2_cran <- x2 |>
    filter (what == "cran_by_year") |>
    select (year, rel_space_R, tabs, indentation) |>
    rename (rel_space = rel_space_R) |>
    mutate (rel_space = rel_space * 4)

p2 <- x2 |>
    filter (what == "annual") |>
    select (year, rel_space_R, tabs, indentation) |>
    rename (rel_space = rel_space_R) |>
    mutate (rel_space = rel_space * 4) |>
    ggplot (aes (x = year)) +
    geom_line (aes (y = rel_space, col = "rel_space")) +
    geom_line (aes (y = tabs, col = "tabs")) +
    geom_line (aes (y = indentation / coeff_fig10_p2, col = "indentation")) +
    geom_line (data = x2_cran, aes (y = rel_space, col = "rel_space"), lty = 2) +
    geom_line (data = x2_cran, aes (y = tabs, col = "tabs"), lty = 2) +
    geom_line (data = x2_cran, aes (y = indentation / coeff_fig10_p2, col = "indentation"), lty = 2) +
    ylab ("space (x4) | tabs") +
    scale_y_continuous (
        sec.axis = sec_axis (~.*coeff_fig10_p2, name = "Indentation")) +
    ggtitle ("B: Indentation & Spacing") +
        theme (legend.title = element_blank(),
               legend.position = c (0.2, 0.2),
               legend.background = element_rect(fill='transparent', colour='transparent'))

p1 | p2
```
