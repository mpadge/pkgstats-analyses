
```{r fig11-precalc}
datafile <- file.path (here, "data-raw", "pkgstats-results.Rds")
f_fig11 <- file.path (v_data_dir, "fig11.Rds")
calc_fig11 <- !file.exists (f_fig11)
```

```{r fig11-calc, eval = calc_fig11}
x <- load_pkgstats_data (datafile, raw = TRUE, latest = FALSE)
do1 <- function (x, year = 2018) {
    xy <- x |>
        filter (year <= !!year) |>
        group_by (package) |>
        slice_max (date)
    tot_R <- xy$blank_lines_R + xy$comment_lines_R + xy$loc_R
    tot_src <- xy$blank_lines_src + xy$comment_lines_src + xy$loc_src

    tabs <- length (which (xy$indentation < 0)) /
        length (which (!is.na (xy$indentation)))
    indentation <- mean (xy$indentation [xy$indentation >= 0], na.rm = TRUE)

    c (year = year,
       blank_R = mean (xy$blank_lines_R / tot_R, na.rm = TRUE),
       blank_src = mean (xy$blank_lines_src / tot_src, na.rm = TRUE),
       comment_R = mean (xy$comment_lines_R / tot_R, na.rm = TRUE),
       comment_src = mean (xy$comment_lines_src / tot_src, na.rm = TRUE),
       rel_space_R = mean (xy$rel_space_R, na.rm = TRUE),
       tabs = tabs,
       indentation = indentation)
}
years <- sort (unique (x$year))
n <- vapply (years, function (y) do1 (x, y), numeric (8))
n <- data.frame (t (n))
saveRDS (n, f_fig11)
```


```{r fig11, echo = FALSE, warning = FALSE, fig.width = 7, fig.height = 3.5, fig.cap = "**Figure 11.**"}

p1 <- readRDS (f_fig11) |>
    select (year, blank_R, blank_src, comment_R, comment_src) |>
    pivot_longer (cols = c (blank_R, blank_src, comment_R, comment_src)) |>
    ggplot (aes (x = year, y = value, colour = name)) +
        geom_line () +
        ggtitle ("A: Blank & comment lines") +
        ylab ("Proportion") +
        theme (legend.title = element_blank(),
               legend.position = c (0.2, 0.8),
               legend.background = element_rect(fill='transparent', colour='transparent'))

x2 <- readRDS (f_fig11)
coeff_fig11_p2 <- max (x2$indentation) / max (x2$tabs)
colours_fig11_p2 <- c ("rel_space" = "red",
                       "tabs" = "blue",
                       "indentation" = "green")

p2 <- x2 |>
    select (year, rel_space_R, tabs, indentation) |>
    rename (rel_space = rel_space_R) |>
    mutate (rel_space = rel_space * 4) |>
    ggplot (aes (x = year)) +
    geom_line (aes (y = rel_space, col = "rel_space")) +
    geom_line (aes (y = tabs, col = "tabs")) +
    geom_line (aes (y = indentation / coeff_fig11_p2, col = "indentation")) +
    ylab ("space (x4) | tabs") +
    scale_y_continuous (
        sec.axis = sec_axis (~.*coeff_fig11_p2, name = "Indentation")) +
    ggtitle ("B: Indentation & Spacing") +
        theme (legend.title = element_blank(),
               legend.position = c (0.2, 0.2),
               legend.background = element_rect(fill='transparent', colour='transparent'))

p1 | p2
```
