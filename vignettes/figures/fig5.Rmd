
```{r fig5, echo = FALSE, message = FALSE, fig.cap = "**Figure 5** Relative proportions of base, recommended, and contributed packages over time."}
datafile <- file.path (here, "data-raw", "pkgstats-results.Rds")
# select latest packages only
x <- load_pkgstats_data (datafile, raw = TRUE, latest = FALSE) |>
    mutate (year = lubridate::year (date)) |>
    group_by (package) |>
    slice_max (date)
x <- x [which (!(is.na (x$external_calls) | x$external_calls == "")), ]

recommended_pkgs <- function () {

    u <- "https://github.com/wch/r-source/tree/trunk/src/library"
    r <- rvest::read_html (u)

    a <- rvest::html_elements (r, "div") |>
        rvest::html_elements ("a")

    titles <- rvest::html_attr (a, "title")
    classes <- rvest::html_attr (a, "class")
    recommended <- titles [grep ("primary", classes)]
    index <- which (!(is.na (recommended) |
                      grepl ("\\.|^Rec|^base", recommended)))
    recommended <- recommended [index]

    return (recommended)
}

recommended <- recommended_pkgs ()

deps <- lapply (seq (nrow (x)), function (i) {
                    # a few have rogue colons at start:
                    ex <- gsub ("^\\:", "", x$external_calls [i])
                    out <- strsplit (strsplit (ex, ",") [[1]], "\\:")
                    lens <- vapply (out, length, integer (1))
                    out <- do.call (rbind, out [which (lens == 3)])
                    
                    this_pkg <- x$package [i]
                    out <- out [which (out [, 1] != this_pkg), , drop = FALSE]

                    n_total <- as.integer (out [, 2])
                    n_unique <- as.integer (out [, 3])
                    pkg <- out [, 1]

                    i_base <- which (pkg == "base")
                    i_rcmd <- which (pkg %in% recommended)
                    i_ctb <- seq_along (pkg) [-c (i_base, i_rcmd)]

                    n <- nrow (out)

                    return (c (
                        package = this_pkg,
                        month = x$month [i],
                        n_total_base <- sum (n_total [i_base]),
                        n_total_rmcd <- sum (n_total [i_rcmd]),
                        n_total_ctb <- sum (n_total [i_ctb]),

                        n_unique_base <- sum (n_unique [i_base]),
                        n_unique_rmcd <- sum (n_unique [i_rcmd]),
                        n_unique_ctb <- sum (n_unique [i_ctb])
                    ))
})

deps <- do.call (rbind, deps)

deps_full <- data.frame (package = deps [, 1],
                         date =  lubridate::as_date (as.integer (deps [, 2])),
                         n_total_base = as.integer (deps [, 3]),
                         n_total_rmcd = as.integer (deps [, 4]),
                         n_total_ctb = as.integer (deps [, 5]),
                         n_unique_base = as.integer (deps [, 6]),
                         n_unique_rmcd = as.integer (deps [, 7]),
                         n_unique_ctb = as.integer (deps [, 8]))

deps <- deps_full |>
    mutate (year = lubridate::year (date),
            n_total = n_total_base + n_total_rmcd + n_total_ctb,
            n_unique = n_unique_base + n_unique_rmcd + n_unique_ctb) |>
    group_by (year) |>
    summarise (base_total = sum (n_total_base) / sum (n_total),
               recommended_total = sum (n_total_rmcd) / sum (n_total),
               contributed_total = sum (n_total_ctb) / sum (n_total),
               base_unique = sum (n_unique_base) / sum (n_unique),
               recommended_unique = sum (n_unique_rmcd) / sum (n_unique),
               contributed_unique = sum (n_unique_ctb) / sum (n_unique))

deps <- pivot_longer (deps,
                      cols = c (base_total, recommended_total, contributed_total,
                                base_unique, recommended_unique, contributed_unique),
                      names_to = c ("total", "unique"),
                      names_sep = "\\_") |>
    rename (proportion = value,
            type = total,
            category = unique)

#ggplot (deps, aes (x = year, y = proportion, color = type)) +
#    geom_line () +
#    facet_wrap (~category) +
#    theme (legend.position = c (0.1, 0.7),
#           legend.background = element_rect(fill='transparent', colour='transparent'))

deps <- deps [deps$category == "unique", ]

ggplot (deps, aes (x = year, y = proportion, color = type)) +
    geom_line () +
    theme (legend.position = c (0.2, 0.7),
           legend.background = element_rect(fill='transparent', colour='transparent'))
```
