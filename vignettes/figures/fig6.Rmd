

```{r fig6-pre-load}
datafile <- file.path (here, "data-raw", "pkgstats-results.Rds")
x <- load_pkgstats_data (datafile, raw = TRUE, latest = FALSE) 
deps <- coupling_dependencies (x)
recommended <- recommended_pkgs ()
```
```{r}
deps2 <- deps |>
    group_by (from, version) |>
    summarise (n_base = n_unique [to == "base"],
               n_recommended = sum (n_unique [to %in% recommended]),
               n_contrib = sum (n_unique [!to %in% c ("base", recommended)]),
               .groups = "keep") |>
    mutate (n_total = n_base + n_recommended + n_contrib,
            n_base = n_base / n_total,
            n_recommended = n_recommended / n_total,
            n_contrib = n_contrib / n_total) |>
    group_by (from) |>
    summarise (n_base = n_base / lag (n_base),
               n_recommended = n_recommended / lag (n_recommended),
               n_contrib = n_contrib / lag (n_contrib),
               seq = seq_along (n_base),
               .groups = "keep") |>
    mutate_at(vars (n_base, n_recommended, n_contrib),
              ~replace (., !is.finite (.), NA)) |>
    group_by (seq) |>
    summarise (n_base = mean (n_base, na.rm = TRUE),
               n_recommended = mean (n_recommended, na.rm = TRUE),
               n_contrib = mean (n_contrib, na.rm = TRUE)) |>
    pivot_longer (cols = c (n_base, n_recommended, n_contrib)) |>
    filter (is.finite (value))

deps2 |>
    filter (seq <= 50 & name != "n_contrib") |>
    ggplot (aes (x = seq, y = value, colour = name)) +
        geom_line (lty = 2) +
        geom_smooth (method = "loess", formula = "y ~ x") +
        theme (legend.title = element_blank(),
               legend.position = c (0.50, 0.9),
               legend.background = element_rect(fill='transparent', colour='transparent')) +
        xlab ("Release sequence") +
        ylab ("Relative changes per release") +
        ggtitle ("B: Change in calls") -> p1
```


```{r load-couplings-releases}
f <- file.path (here, "data-raw", "couplings_releases.Rds")
if (!file.exists (f)) {
    u <- paste0 ("https://github.com/mpadge/pkgstats-analyses/",
                 "releases/download/v0.0.1/",
                 "couplings_releases.Rds")
    download.file (u, f)
}
```

```{r couplings-releases}
# unique & total instabilities are virtually identical
deps <- readRDS (f)
#deps$efferent_unique [deps$efferent_unique == 0L] <- NA_integer_
deps <- deps |>
    group_by (seq) |>
    summarise (instability = mean (instability_unique, na.rm = TRUE),
               efferent = mean (efferent_unique, na.rm = TRUE))
coeff <- max (deps$efferent, na.rm = TRUE) / max (deps$instability)
colours <- c ("instability" = "red",
              "efferent" = "blue")
deps |>
    filter (seq <= 100) |>
    ggplot (aes (x = seq)) +
        geom_line (aes (y = instability, col = "instability")) +
        geom_line (aes (y = efferent / coeff, col = "efferent")) +
        scale_y_continuous (
            name = "instability",
            sec.axis = sec_axis (~.*coeff, name = "Efferent calls")) +
        xlab ("Release sequence") +
        scale_colour_manual (values = colours) +
        theme (legend.title = element_blank(),
           legend.position = c (0.80, 0.8),
           legend.background = element_rect(fill='transparent', colour='transparent')) +
        ggtitle ("B: Coupling instability") -> p2
```

```{r, fig.cap = "**Fig. 6**"}
p1 + p2
```
